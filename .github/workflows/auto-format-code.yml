name: Auto Format Code

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'  # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ –ø–æ–ª–Ω–æ—á—å

jobs:
  format-code:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install formatting tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort autopep8
        
    - name: Check code formatting
      id: format-check
      continue-on-error: true
      run: |
        echo "=== Checking code formatting ==="
        echo "1. Black formatting..."
        black --check --line-length=90 . || true
        
        echo "2. Import sorting..."
        isort --check-only . || true
        
        echo "3. PEP8 violations..."
        autopep8 --diff --recursive --aggressive --max-line-length=90 . || true
    
    - name: Auto-format all Python files
      if: steps.format-check.outcome == 'failure'
      run: |
        echo "=== Auto-formatting Python files ==="
        
        # 1. –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã
        echo "Sorting imports..."
        isort .
        
        # 2. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å Black
        echo "Formatting with Black..."
        black --line-length=90 .
        
        # 3. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º PEP8
        echo "Fixing PEP8 issues..."
        autopep8 --in-place --recursive --aggressive --max-line-length=90 .
        
        echo "=== Formatted files ==="
        git diff --name-only || echo "No changes"
        
    - name: Create formatted code report
      if: steps.format-check.outcome == 'failure'
      run: |
        echo "## üìù –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ –ö–æ–¥ –±—ã–ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:" >> $GITHUB_STEP_SUMMARY
        echo "- **isort**: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤" >> $GITHUB_STEP_SUMMARY
        echo "- **Black**: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞" >> $GITHUB_STEP_SUMMARY
        echo "- **autopep8**: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PEP8 –Ω–∞—Ä—É—à–µ–Ω–∏–π" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        git diff --name-only >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No changes" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
    
    - name: Commit and push formatting changes
      if: steps.format-check.outcome == 'failure'
      run: |
        echo "=== Committing formatting changes ==="
        
        if git diff --quiet; then
          echo "No changes to commit"
        else
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # –î–ª—è PR —Å–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—É—é –≤–µ—Ç–∫—É
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME="formatting/auto-format-${{ github.run_number }}"
            git checkout -b $BRANCH_NAME
            git add .
            git commit -m "style: auto-format code [skip ci]"
            git push --set-upstream origin $BRANCH_NAME
            echo "Created PR branch: $BRANCH_NAME"
          else
            # –î–ª—è push –≤ main/develop –∫–æ–º–º–∏—Ç–∏–º –Ω–∞–ø—Ä—è–º—É—é
            git add .
            git commit -m "style: auto-format code [skip ci]"
            git push
          fi
        fi
