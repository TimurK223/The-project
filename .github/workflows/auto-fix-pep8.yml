name: Auto Fix PEP8

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install auto-fix tools
      run: |
        python -m pip install --upgrade pip
        pip install autopep8 black pycodestyle
        
    - name: Check current PEP8 status
      id: check-before
      continue-on-error: true
      run: |
        echo "=== PEP8 errors before fixing ==="
        pycodestyle --max-line-length=90 --statistics . || true
        
    - name: Auto-fix all PEP8 issues
      run: |
        echo "=== Fixing PEP8 issues automatically ==="
        
        # 1. Исправляем голые except
        echo "Fixing bare except statements..."
        find . -name "*.py" -type f -exec sed -i 's/^\(\s*\)except:$/\1except Exception:/g' {} \;
        
        # 2. Удаляем trailing whitespace
        echo "Removing trailing whitespace..."
        find . -name "*.py" -type f -exec sed -i 's/[[:space:]]*$//' {} \;
        
        # 3. Исправляем отступы и пробелы
        echo "Fixing indentation and spacing..."
        autopep8 --in-place --recursive --aggressive --max-line-length=90 .
        
        # 4. Форматируем с Black
        echo "Formatting with Black..."
        black --line-length=90 .
        
        # 5. Исправляем переносы строк
        echo "Fixing line endings..."
        find . -name "*.py" -type f -exec sed -i 's/\r$//' {} \;
    
    - name: Check PEP8 status after fixing
      id: check-after
      run: |
        echo "=== PEP8 errors after fixing ==="
        pycodestyle --max-line-length=90 --statistics . || echo "No errors found!"
        
    - name: Create Pull Request with fixes
      if: github.event_name == 'pull_request' && steps.check-before.outcome == 'failure'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "style: auto-fix PEP8 violations"
        title: "Auto-fix: PEP8 corrections"
        body: |
          ## PEP8 Auto-fix Report
          
          Автоматически исправлены следующие ошибки PEP8:
          
          - ✅ Исправлены голые except (`except:` → `except Exception:`)
          - ✅ Удалены пробелы в конце строк (trailing whitespace)
          - ✅ Исправлены отступы и пробелы
          - ✅ Применено форматирование Black
          - ✅ Исправлены переносы строк
          
          Файлы были автоматически отформатированы.
          
          Статус проверки:
          - До исправлений: ❌ Были ошибки
          - После исправлений: ✅ Все проверки пройдены
          
          **Изменения автоматически применены к этому PR.**
        branch: auto-fix-pep8-${{ github.run_number }}
        delete-branch: true
    
    - name: Commit and push fixes for main branch
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        if ! git diff --quiet; then
          echo "=== Committing fixes to main branch ==="
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "style: auto-fix PEP8 violations [skip ci]"
          git push
        else
          echo "No formatting changes needed"
        fi
